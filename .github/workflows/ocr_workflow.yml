name: OCR Workflow

on:
  push:
    paths:
      - 'analyse/**'

jobs:
  ocr-extraction:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      # Installation obligatoire de Tesseract OCR avec la langue fran√ßaise
      - name: Installer Tesseract OCR
        run: sudo apt-get install -y tesseract-ocr tesseract-ocr-fra

      # Installation des d√©pendances Python
      - name: Installer Python et d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install pytesseract Pillow

      # √âtape OCR : G√©n√©rer les r√©sultats √† partir des images pr√©sentes dans le dossier analyse
      - name: Ex√©cuter l'OCR sur les images du dossier analyse
        run: |
          mkdir -p results
          echo "R√©sultats OCR :" > results/resultat_ocr.txt
          for img in analyse/*.jpg analyse/*.png; do
            [ -f "$img" ] || continue
            texte=$(tesseract "$img" stdout -l fra)
            echo "üñºÔ∏è Image : $(basename "$img")" >> results/resultat_ocr.txt
            echo "$texte" >> results/resultat_ocr.txt
            echo "---------------------------------------" >> results/resultat_ocr.txt
          done
          cat results/resultat_ocr.txt  # Affiche les r√©sultats OCR dans le log d'action (pour v√©rifier)

      # G√©n√©rer explicitement la page HTML avec les r√©sultats OCR
      - name: G√©n√©rer automatiquement la page HTML finale
        run: |
          mkdir -p docs
          echo "<!DOCTYPE html>" > docs/index.html
          echo "<html lang='fr'><head><meta charset='UTF-8'><title>R√©sultats OCR</title></head><body>" >> docs/index.html
          echo "<h1>R√©sultats OCR</h1><pre>" >> docs/index.html
          cat results/resultat_ocr.txt >> docs/index.html
          echo "</pre></body></html>" >> docs/index.html

      # Commit et Push automatique des r√©sultats avec le Token explicite
      - name: Commit et Push automatique des r√©sultats OCR
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üîÑ Mise √† jour automatique r√©sultats OCR"
          branch: main
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
